## Part 1. Инструмент ipcalc

### 1.1. Сети и маски
##### 1) Адрес сети *192.167.38.54/13*

![img.png](images/img.png)

##### 2.1) Перевод маски *255.255.255.0* в префиксную и двоичную запись

![img_2.png](images/img_2.png)

>Префикс /24
> 
##### 2.2) /15 в обычную и двоичную

![img_1.png](images/img_1.png)

##### 2.3) 11111111.11111111.11111111.11110000 в обычную и префиксную

![img_3.png](images/img_3.png)

* В обычную -  255.255.255.240
* В префиксную - /28

##### 3) Минимальный и максимальный хост в сети 12.167.38.4 при масках:

* 3.1) /8

![img_5.png](images/img_5.png)

* 3.2) 11111111.11111111.00000000.00000000

![img_6.png](images/img_6.png)

* 3.3) 255.255.254.0

![img_7.png](images/img_7.png)

* 3.4) /4

![img_4.png](images/img_4.png)

### 1.2. localhost

##### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

Поочередно пропингуем

* 194.34.23.100

![img_8.png](images/img_8.png)

>Пинг не проходит, обратиться нельзя

* 127.0.0.2

![img_9.png](images/img_9.png)

>Пинг проходит, обратиться можно

* 127.1.0.1

![img_10.png](images/img_10.png)

>Пинг проходит, обратиться можно

* 128.0.0.1

![img_11.png](images/img_11.png)

>Пинг не проходит, обратиться нельзя

### 1.3. Диапазоны и сегменты сетей

##### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

#### Классификация IP

Существуют классификации IP-адресов как "частных" и "общедоступных". Следующие диапазоны адресов зарезервированы для частных сетей (также известных как LAN):
- *10.0.0.0* — *10.255.255.255* (*10.0.0.0/8*),
- *172.16.0.0* — *172.31.255.255* (*172.16.0.0/12*),
- *192.168.0.0* — *192.168.255.255* (*192.168.0.0/16*).
- *127.0.0.0* — *127.255.255.255* (Зарезервировано для интерфейсов обратной связи (не используется для связи между узлами сети), так называемый localhost)

Следовательно:

* 10.0.0.45 - частный
* 134.43.0.2 - публичный
* 192.168.4.2 - частный
* 172.20.250.4 - частный
* 172.0.2.1 - публичный
* 192.172.0.1 - публичный
* 172.68.0.2 - публичный
* 172.16.255.255 - частный

Так же приведу пару примеров с использованием ipcalc

![img_12.png](images/img_12.png)

* 10.10.10.10 - частный

![img_13.png](images/img_13.png)

* 192.169.168.1 - публичный

##### 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

![img_14.png](images/img_14.png)


Диапазон 10.10.0.1 - 10.10.63.254. Сопоставляем:

* 10.0.0.1 - невозможен
* 10.10.0.2 - возможен
* 10.10.10.10 - возможен
* 10.10.100.1 - невозможен
* 10.10.1.255 - возможен

## Part 2. Статическая маршрутизация между двумя машинами

##### С помощью команды `ip a` посмотреть существующие сетевые интерфейсы

Для машины ws1:

![img_15.png](images/img_15.png)

Для машины ws2:

![img_16.png](images/img_16.png)

Опишем сетевой интерфейс для обеих машин

etc/netplan/00-installer-config.yaml файл для первой машины:

![img_17.png](images/img_17.png)

etc/netplan/00-installer-config.yaml файл для второй машины:

![img_18.png](images/img_18.png)

Здесь мы прописали соответствующие адреса

Для подтверждения изменений прописываем команду netplan apply. В случае успешного выполнения ничего не будет выведено

![img_19.png](images/img_19.png)

### 2.1. Добавление статического маршрута вручную

Построим статический маршрут от одной машины до другой при помощи команды ip r add

![img_20.png](images/img_20.png)

Дла второй аналогично, с имзенением адреса, указывая первую машину

Попробуем пропинговать

![img_21.png](images/img_21.png)
![img_22.png](images/img_22.png)

Пинг проходит от ws1 к ws2 и наоборот

### 2.2. Добавление статического маршрута с сохранением

После перезапуска машин маршруты, установленые вручную, сбросятся. Изменим yaml файлы для сохранения маршрутов

Для первой машины указываем путь до второй машины:

![img_23.png](images/img_23.png)

Аналогично в обратную сторону для второй машины:

![img_24.png](images/img_24.png)

Пропингуем для проверки

![img_25.png](images/img_25.png)
![img_26.png](images/img_26.png)

Статическая маршрутизация установлена

## Part 3. Утилита **iperf3**

### 3.1. Скорость соединения
##### Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps

* 8 Mbp/s = 1 MB/s
* 100 MB/s = 819200 Kbp/s
* 1 Gbp/s = 1024 Mbp/s

### 3.2. Утилита **iperf3**
##### Измерим скорость соединения между ws1 и ws2

Для этого введем в консоль машины-сервера (ws1) команду:

![img_27.png](images/img_27.png)

Далее с машины-клиента (ws2) запустим тест

![img_28.png](images/img_28.png)

Тем временем на сервер так же придет результат

![img_29.png](images/img_29.png)

## Part 4. Сетевой экран

### 4.1. Утилита **iptables**

Создадим файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2

Для ws1:

![img_30.png](images/img_30.png)

Для ws2:

![img_31.png](images/img_31.png)

Запустим оба файла

![img_32.png](images/img_32.png)
![img_33.png](images/img_33.png)

При успешном выполнении команды в консоль ничего не выведется

Разница в стратегиях заключается в том, что на первой машине у нас сначала идет правило, запрещающее пинг, и только после него - разрешающее, в то время как на второй машине ровно наоборот - сначала разрешение, потом запрет

Пропинговав 1ю машину, выясним, что она не пингуется, хотя хост поднят:

![img_34.png](images/img_34.png)

Пропингуем 2ю машину:

![img_35.png](images/img_35.png)

## Part 5. Статическая маршрутизация сети

Для создания сети, настроим машины в VirtualBox, а именно - откроем сетевые адаптеры. Для рабочих станций будет 2 адаптера (один для выхода в интернет, другой для внутренней сети), дла роутеров - 3 (согласно схеме, у каждого роутера 2 внутренние сети)

![img_36.png](images/img_36.png)
![img_37.png](images/img_37.png)

Для роутера будет открыт 3-й адаптер для внутренней сети

![img_38.png](images/img_38.png)

Далее прописываем etc/netplan/00-installer-config.yaml для каждой машины

Для ws11:

![img_39.png](images/img_39.png)

Для r1:

![img_40.png](images/img_40.png)

Для r2:

![img_41.png](images/img_41.png)

Для ws22:

![img_42.png](images/img_42.png)

Для ws21:

![img_43.png](images/img_43.png)

Пропингуем с ws11 r1:

![img_44.png](images/img_44.png)

С ws21 пропингуем ws22:

![img_45.png](images/img_45.png)

### 5.2. Включение переадресации IP-адресов.
Для включения переадресации IP, выполним команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1`

![img_46.png](images/img_46.png)
![img_47.png](images/img_47.png)

При таком подходе переадресация не будет работать после перезагрузки системы

Откроем файл /etc/sysctl.conf и добавьте в него следующую строку:
`net.ipv4.ip_forward = 1`

![img_48.png](images/img_48.png)
![img_49.png](images/img_49.png)

При использовании этого подхода, IP-переадресация включена на постоянной основе.

### 5.3. Установка маршрута по-умолчанию

Настроить маршрут по-умолчанию (шлюз) для рабочих станций

Для ws11:

![img_50.png](images/img_50.png)

Для других двух машин аналогично указывается адрес роутера r2

Через `ip r` убедимся, что маршрут добавился в таблицу маршрутизации

![img_51.png](images/img_51.png)

Пропингуем с ws11 роутер r2:

![img_52.png](images/img_52.png)

Пинг не возвращается, однако, убедимся, что он доходит:

![img_53.png](images/img_53.png)

### 5.4. Добавление статических маршрутов

Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций

Для r1:

![img_54.png](images/img_54.png)

Для r2:

![img_55.png](images/img_55.png)

Через `ip r` посмотрим таблицы маршрутизации на обоих роутерах

Для r1:

![img_56.png](images/img_56.png)

Для r2:

![img_57.png](images/img_57.png)

Запустим команды на ws11:
`ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`:

![img_58.png](images/img_58.png)

В компьютерных сетях маршрут по умолчанию - это конфигурация интернет-протокола (IP), которая устанавливает правило пересылки для пакетов, когда конкретный адрес узла следующего перехода недоступен из таблицы маршрутизации или других механизмов маршрутизации.

Маршрут по умолчанию - это, как правило, адрес другого маршрутизатора, который обрабатывает пакет таким же образом: если маршрут совпадает, пакет пересылается соответствующим образом, в противном случае пакет пересылается на маршрут по умолчанию этого маршрутизатора. Процесс оценки маршрута в каждом маршрутизаторе использует метод сопоставления с самым длинным префиксом для получения наиболее конкретного маршрута. Сеть с самой длинной маской подсети или сетевым префиксом, который соответствует IP-адресу назначения, является сетевым шлюзом следующего перехода. Процесс повторяется до тех пор, пока пакет не будет доставлен на узел назначения, или ранее по маршруту, когда маршрутизатор не имеет доступного маршрута по умолчанию и не может направить пакет иным способом. В последнем случае пакет отбрасывается, и может быть возвращено сообщение о недоступности назначения ICMP.[1] Каждый обход маршрутизатора считается одним переходом при расчете расстояния для пути передачи.

Устройство, на которое указывает маршрут по умолчанию, часто называют шлюзом по умолчанию, и оно часто выполняет другие функции, такие как фильтрация пакетов, брандмауэр или операции прокси-сервера.

Маршрут по умолчанию в Internet Protocol версии 4 (IPv4) обозначается как нулевой адрес, 0.0.0.0/0 в нотации CIDR.[2] Аналогично, в IPv6 маршрут по умолчанию задается с помощью ::/0. Маска подсети задается как /0, что эффективно определяет все сети и является кратчайшим возможным совпадением. Поиск маршрута, который не соответствует ни одному другому правилу, возвращается к этому маршруту.

В сегменте сети самого высокого уровня администраторы обычно указывают маршрут по умолчанию для данного хоста к маршрутизатору, который подключен к поставщику сетевых услуг. Таким образом, пакеты с адресатами за пределами локальной сети организации, обычно адресатами в Интернете или глобальной сети, пересылаются на маршрутизатор с подключением к этому провайдеру.

### 5.5. Построение списка маршрутизаторов

Запустим на r1 команду дампа:
`tcpdump -tnv -i eth0`

После этого запустим команду `traceroute`:

![img_60.png](images/img_60.png)

В этот момент на r1:

![img_59.png](images/img_59.png)

`traceroute` передвигается по маршрутам по умолчанию, посылает по 3 пакета и засекает время

### 5.6. Использование протокола **ICMP** при маршрутизации
Запустим на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`

![img_61.png](images/img_61.png)

Пропингуем с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`

![img_62.png](images/img_62.png)

Тем временем на r1:

![img_63.png](images/img_63.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**

Для r2 настроим в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:

### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.

`apt install isc-dhcp-server`

![img_64.png](images/img_64.png)

### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`

![img_65.png](images/img_65.png)

Перезагрузим службу **DHCP** командой `systemctl restart isc-dhcp-server`

![img_66.png](images/img_66.png)

Перепишем yaml файл, чтобы получать IP по dhcp

![img_67.png](images/img_67.png)

Машину ws21 перезагрузим при помощи `reboot` и через `ip a` покажем, что она получила адрес:

![img_68.png](images/img_68.png)

Пропингуем ws22 с ws21:

![img_69.png](images/img_69.png)

Укажем MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

![img_70.png](images/img_70.png)

Так же укажем этот адрес в соответствующем адаптере виртуальной машины

![img_74.png](images/img_74.png)

Проделаем аналогично для r1 с привязкой по MAC-адресу

![img_71.png](images/img_71.png)

В файле *resolv.conf* пропишем `nameserver 8.8.8.8.`

![img_72.png](images/img_72.png)

Перезагрузим службу **DHCP** командой `systemctl restart isc-dhcp-server`

![img_73.png](images/img_73.png)

Запросим с ws21 новый ip:

![img_76.png](images/img_76.png)

![img_75.png](images/img_75.png)

Материалы к 6-й части:
* https://www.opennet.ru/base/net/dhcp_setup.txt.html
* https://www.youtube.com/watch?v=HDpCo7DvsgY

## Part 7. **NAT**

В файле */etc/apache2/ports.conf* на ws22 и r1 изменим строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделаем сервер Apache2 общедоступным

![img_77.png](images/img_77.png)

Запустим веб-сервер Apache командой `service apache2 start` на ws22 и r1

![img_78.png](images/img_78.png)

Добавим в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) Удаление правил в таблице filter - `iptables -F`
2) Удаление правил в таблице "NAT" - `iptables -F -t nat`
3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`

![img_79.png](images/img_79.png)

Запустим файл

![img_80.png](images/img_80.png)

Проверим соединение между ws22 и r1 командой `ping`

![img_81.png](images/img_81.png)
![img_82.png](images/img_82.png)

4) Разрешим маршрутизацию всех пакетов протокола **ICMP**

![img_83.png](images/img_83.png)

Проверим соединение между ws22 и r1 командой `ping`

![img_84.png](images/img_84.png)

Добавим в файл ещё два правила:
5) Включим **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

6) Включим **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![img_85.png](images/img_85.png)

Проверим соединение по TCP для **SNAT**, для этого с ws22 подключимся к серверу Apache на r1 командой:
`telnet [адрес] [порт]`

Проверим соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` 

![img_86.png](images/img_86.png)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

Запустить на r2 фаервол с правилами из Части 7

![img_87.png](images/img_87.png)

Запустим веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменим строку `Listen 80` на `Listen localhost:80`)

![img_88.png](images/img_88.png)

Воспользуемся *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

Запустим с ws21 `ssh -L local_port:remote_ip:remote_port user@hostname`
![img_89.png](images/img_89.png)
![img_90.png](images/img_90.png)

Воспользуемся *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

Запустим с ws11 `ssh -R remote_port:local_ip:local_port user@hostname`

![img_91.png](images/img_91.png)

Проверим

![img_93.png](images/img_93.png)

![img_92.png](images/img_92.png)
